org: flanche
service: chinawok-pedidos

provider:
  name: aws
  runtime: python3.12
  memorySize: 512
  timeout: 300
  region: us-east-1
  
  environment:
    TABLE_LOCALES: ${env:TABLE_LOCALES, 'ChinaWok-Locales'}
    TABLE_COMBOS: ${env:TABLE_COMBOS, 'ChinaWok-Combos'}
    TABLE_OFERTAS: ${env:TABLE_OFERTAS, 'ChinaWok-Ofertas'}
    TABLE_PEDIDOS: ${env:TABLE_PEDIDOS, 'ChinaWok-Pedidos'}
    TABLE_PRODUCTOS: ${env:TABLE_PRODUCTOS, 'ChinaWok-Productos'}
    TABLE_USUARIOS: ${env:TABLE_USUARIOS, 'ChinaWok-Usuarios'}
    AWS_ACCOUNT_ID: ${env:AWS_ACCOUNT_ID}
    CHINAWOK_REGION: ${self:provider.region}
    STEP_FUNCTION_PEDIDOS_NAME: ${env:STEP_FUNCTION_PEDIDOS_NAME, 'ChinaWok-Pedidos-Processor'}
    EVENT_BUS_NAME: ${env:EVENT_BUS_NAME, 'chinawok-pedidos-events'}
  
  iam:
    role: arn:aws:iam::${env:AWS_ACCOUNT_ID}:role/LabRole

functions:
  # ==================== COMBOS ====================
  combosCreate:
    handler: Combos/create.handler
    name: ${self:service}-combos-create
    description: Crear un combo
    events:
      - http:
          path: combos
          method: post
          cors: true
  
  combosRead:
    handler: Combos/read.handler
    name: ${self:service}-combos-read
    description: Leer combos por local
    events:
      - http:
          path: combos
          method: get
          cors: true
  
  combosUpdate:
    handler: Combos/update.handler
    name: ${self:service}-combos-update
    description: Actualizar un combo
    events:
      - http:
          path: combos
          method: put
          cors: true
  
  combosDelete:
    handler: Combos/delete.handler
    name: ${self:service}-combos-delete
    description: Eliminar un combo
    events:
      - http:
          path: combos
          method: delete
          cors: true
  
  # ==================== OFERTAS ====================
  ofertasCreate:
    handler: Ofertas/create.handler
    name: ${self:service}-ofertas-create
    description: Crear una oferta
    events:
      - http:
          path: ofertas
          method: post
          cors: true
  
  ofertasRead:
    handler: Ofertas/read.handler
    name: ${self:service}-ofertas-read
    description: Leer ofertas por local
    events:
      - http:
          path: ofertas
          method: get
          cors: true
  
  ofertasUpdate:
    handler: Ofertas/update.handler
    name: ${self:service}-ofertas-update
    description: Actualizar una oferta
    events:
      - http:
          path: ofertas
          method: put
          cors: true
  
  ofertasDelete:
    handler: Ofertas/delete.handler
    name: ${self:service}-ofertas-delete
    description: Eliminar una oferta
    events:
      - http:
          path: ofertas
          method: delete
          cors: true
  
  # ==================== PEDIDOS ====================
  pedidosCreate:
    handler: Pedido/create.handler
    name: ${self:service}-pedidos-create
    description: Crear un pedido
    events:
      - http:
          path: pedidos
          method: post
          cors: true
  
  pedidosRead:
    handler: Pedido/read.handler
    name: ${self:service}-pedidos-read
    description: Leer pedidos por local
    events:
      - http:
          path: pedidos
          method: get
          cors: true
  
  pedidosUpdate:
    handler: Pedido/update.handler
    name: ${self:service}-pedidos-update
    description: Actualizar un pedido
    events:
      - http:
          path: pedidos
          method: put
          cors: true
  
  pedidosDelete:
    handler: Pedido/delete.handler
    name: ${self:service}-pedidos-delete
    description: Eliminar un pedido
    events:
      - http:
          path: pedidos
          method: delete
          cors: true
  
  # ==================== PRODUCTOS ====================
  productosCreate:
    handler: Producto/create.handler
    name: ${self:service}-productos-create
    description: Crear un producto
    events:
      - http:
          path: productos
          method: post
          cors: true
  
  productosRead:
    handler: Producto/read.handler
    name: ${self:service}-productos-read
    description: Leer productos por local
    events:
      - http:
          path: productos
          method: get
          cors: true
  
  productosUpdate:
    handler: Producto/update.handler
    name: ${self:service}-productos-update
    description: Actualizar un producto
    events:
      - http:
          path: productos
          method: put
          cors: true
  
  productosDelete:
    handler: Producto/delete.handler
    name: ${self:service}-productos-delete
    description: Eliminar un producto
    events:
      - http:
          path: productos
          method: delete
          cors: true

  # ==================== EVENTBRIDGE ====================
  # Nota: EventBridge invocará directamente el Step Function
  # La regla se debe crear manualmente o con CloudFormation resources
  # Esta función Lambda ya no es necesaria si EventBridge va directo al Step Function

custom:
  pythonRequirements:
    dockerizePip: true
    slim: true

# Recursos adicionales para crear la regla de EventBridge que apunte al Step Function
resources:
  Resources:
    PedidoCreadoEventRule:
      Type: AWS::Events::Rule
      Properties:
        Name: ${self:service}-rules
        Description: Reglas para enviar pedidos creados al Step Function
        EventBusName: ${env:EVENT_BUS_NAME, 'chinawok-pedidos-events'}
        EventPattern:
          source:
            - chinawok.pedidos
          detail-type:
            - PedidoCreado
        State: ENABLED
        Targets:
          - Arn: arn:aws:states:${self:provider.region}:${env:AWS_ACCOUNT_ID}:stateMachine:${env:STEP_FUNCTION_PEDIDOS_NAME, 'ChinaWok-Pedidos-Processor'}
            Id: PedidoCreadoStepFunction
            RoleArn: arn:aws:iam::${env:AWS_ACCOUNT_ID}:role/LabRole

package:
  individually: false
  exclude:
    - node_modules/**
    - .git/**
    - .env
    - __pycache__/**
    - "*.pyc"